{% extends "base.html" %}

{% block title %}My Bookings - Flight Reservation System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-ticket-fill me-2"></i>My Bookings
            </h2>

            <div id="loadingBookings" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="bookingsContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th>ID</th>
                                <th>Flight</th>
                                <th>Route</th>
                                <th>Class / Seat</th>
                                <th>Date & Time</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable">
                            <!-- Bookings will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="noBookings" style="display: none;" class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h3 class="mt-3 text-muted">No bookings yet</h3>
                <p class="text-muted">Start by searching for flights</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-search me-2"></i>Search Flights
                </a>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal (Compact Design) -->
    <div class="modal fade" id="ticketModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 bg-transparent">
                <div
                    class="ticket-card-content animate-fade-in p-3 bg-white rounded-4 shadow-lg position-relative overflow-hidden">

                    <!-- Compact Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success fs-5 me-2"></i>
                            <h5 class="mb-0 fw-bold text-dark">Ticket Confirmed</h5>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- Main Flight Info -->
                    <div class="row g-0 align-items-center mb-3">
                        <div class="col-8 border-end pe-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span
                                    class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25"
                                    id="ticketFlightNumber"></span>
                                <span class="badge bg-secondary" id="ticketClass"></span>
                                <span class="badge bg-light text-dark border" id="ticketSeatNo"></span>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <h4 id="ticketSource" class="mb-0 fw-bold text-dark"></h4>
                                    <div class="text-muted" style="font-size: 0.75rem;">Origin</div>
                                </div>
                                <i class="bi bi-airplane text-primary mx-2 fs-5"></i>
                                <div class="text-end">
                                    <h4 id="ticketDestination" class="mb-0 fw-bold text-dark"></h4>
                                    <div class="text-muted" style="font-size: 0.75rem;">Destination</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="bi bi-calendar me-1"></i><span id="ticketDate"></span></span>
                                <span><i class="bi bi-clock me-1"></i><span id="ticketTime"></span></span>
                            </div>
                        </div>
                        <div class="col-4 ps-3 text-center">
                            <div class="bg-light p-2 rounded-3 border">
                                <small class="text-muted d-block text-uppercase"
                                    style="font-size: 0.65rem; letter-spacing: 1px;">Booking ID</small>
                                <div id="ticketId" class="fw-bold text-primary mb-2"></div>
                                <div class="border-top pt-2">
                                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem;">Total
                                        Paid</small>
                                    <span id="ticketPrice" class="fs-5 fw-bold text-dark"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Passenger & Preview -->
                    <div class="d-flex bg-light rounded-3 overflow-hidden" style="height: 80px;">
                        <div class="p-2 flex-grow-1 overflow-auto">
                            <small class="text-muted d-block uppercase mb-1"
                                style="font-size: 0.7rem;">PASSENGERS</small>
                            <div id="ticketPassengers" class="fw-bold text-dark small text-truncate"
                                style="max-height: 50px; white-space: pre-wrap;"></div>
                        </div>
                        <div class="position-relative" style="width: 120px;">
                            <img id="ticketCabinImg" src="" style="width: 100%; height: 100%; object-fit: cover;">
                            <div class="position-absolute bottom-0 end-0 p-1">
                                <span class="badge bg-dark bg-opacity-50" style="font-size: 0.6rem;">Interior</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.userBookings = [];

    async function loadBookings() {
        try {
            const response = await fetch('/api/bookings/history');
            const data = await response.json();

            document.getElementById('loadingBookings').style.display = 'none';

            if (response.ok && data.bookings.length > 0) {
                window.userBookings = data.bookings;
                document.getElementById('bookingsContainer').style.display = 'block';

                const tbody = document.getElementById('bookingsTable');
                tbody.innerHTML = data.bookings.map((booking, index) => {
                    const cls = booking.booking_class || 'Economy';
                    const seat = booking.seat_numbers || '-';
                    return `
                    <tr onclick="showTicket(${index})" style="cursor: pointer; transition: all 0.2s;" class="booking-row">
                        <td><strong>#${booking.booking_id}</strong></td>
                        <td>
                            <span class="badge bg-light text-dark border">${booking.flight_number}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center small">
                                <span class="fw-bold">${booking.source}</span>
                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                <span class="fw-bold">${booking.destination}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="badge ${cls === 'First' ? 'bg-warning text-dark' : (cls === 'Business' ? 'bg-info text-dark' : 'bg-secondary')} mb-1">${cls}</span>
                                <small class="text-muted">Seat: <strong>${seat}</strong></small>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <div>${formatDate(booking.date)}</div>
                                <div class="text-muted">${formatTime(booking.departure_time)}</div>
                            </div>
                        </td>
                        <td><strong>₹${booking.total_price.toFixed(0)}</strong></td>
                        <td>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success">
                                <i class="bi bi-check-circle-fill me-1"></i>${booking.status}
                            </span>
                        </td>
                    </tr>
                `}).join('');
            } else {
                document.getElementById('noBookings').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading bookings:', error);
            document.getElementById('loadingBookings').style.display = 'none';
            document.getElementById('noBookings').style.display = 'block';
        }
    }

    function showTicket(index) {
        const booking = window.userBookings[index];
        if (!booking) return;

        const cls = booking.booking_class || 'Economy';

        // Populate Modal
        document.getElementById('ticketId').textContent = '#' + booking.booking_id;
        document.getElementById('ticketFlightNumber').textContent = booking.flight_number;
        document.getElementById('ticketSource').textContent = booking.source.toUpperCase();
        document.getElementById('ticketDestination').textContent = booking.destination.toUpperCase();
        document.getElementById('ticketDate').textContent = formatDate(booking.date);
        document.getElementById('ticketTime').textContent = formatTime(booking.departure_time);
        document.getElementById('ticketPrice').textContent = '₹' + booking.total_price.toFixed(0);
        document.getElementById('ticketPassengers').textContent = booking.passenger_names;

        // Class & Seat
        const classBadge = document.getElementById('ticketClass');
        classBadge.textContent = cls;
        classBadge.className = `badge ${cls === 'First' ? 'bg-warning text-dark' : (cls === 'Business' ? 'bg-info text-dark' : 'bg-primary')} ms-1`;

        document.getElementById('ticketSeatNo').textContent = booking.seat_numbers || 'N/A';

        // Dynamic Image
        const imgName = getAmbienceImage(cls, booking.source, booking.destination);
        document.getElementById('ticketCabinImg').src = `/static/img/${imgName}`;

        const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
        modal.show();
    }

    function getAmbienceImage(cls, source, dest) {
        const international = ['Dubai', 'London', 'New York', 'Singapore', 'Bangkok'];
        const isIntl = (txt) => international.some(i => txt.includes(i));

        const suffix = (isIntl(source) || isIntl(dest)) ? 'int' : 'dom';
        const map = { 'Economy': 'eco', 'Business': 'bus', 'First': 'first' };
        return `cabin_${map[cls] || 'eco'}_${suffix}.png`;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatTime(timeStr) {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':');
        let hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        hour = hour % 12;
        hour = hour ? hour : 12;
        return `${hour}:${minutes} ${ampm}`;
    }

    loadBookings();
</script>
{% endblock %}